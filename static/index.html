<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI è§†è§‰ç›‘æ§ç³»ç»Ÿ</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      --dark-gradient: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
      --glass-bg: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0a0a0a;
      color: #ffffff;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      overflow-x: hidden;
      font-feature-settings: 'liga' 1, 'kern' 1;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* èƒŒæ™¯ç½‘æ ¼æ•ˆæœ */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
      background-size: 50px 50px;
      pointer-events: none;
      z-index: -1;
    }
    
    #map {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      width: 100vw; height: 100vh;
      z-index: 0;
      filter: brightness(1.08) contrast(1.12) saturate(1.08);
    }

    /* ç»ç’ƒæ€è®¾è®¡ç³»ç»Ÿ */
    .glass-card {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 24px;
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .glass-card-light {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 24px;
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.12),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
      color: #1a1a1a;
    }

    /* ä¾§è¾¹æ è®¾è®¡ */
    .sidebar {
      width: 27vw;
      min-width: 320px;
      max-width: 420px;
      max-height: calc(100vh - 48px);
      z-index: 20;
      display: flex;
      flex-direction: column;
      gap: 24px;
      height: 100vh;
    }
    .sidebar.focus-clear {
      position: fixed;
      z-index: 1001;
      filter: none !important;
      backdrop-filter: none !important;
    }
    /* ä¾§è¾¹æ å†…å®¹åŒºç»“æ„ä¼˜åŒ– */
    .sidebar-content {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .camera-list {
      flex: 1 1 auto;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 24px;
      padding-bottom: 18px;
    }

    .sidebar-header {
      padding: 32px 28px 24px;
      text-align: center;
    }

    .sidebar-title {
      font-size: 28px;
      font-weight: 800;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
      letter-spacing: -0.02em;
    }

    .sidebar-subtitle {
      color: rgba(255, 255, 255, 0.6);
      font-size: 14px;
      font-weight: 500;
    }

    /* ä¸Šä¼ åŒºåŸŸ */
    .upload-zone {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 160px;
      min-height: 180px;
      width: 100%;
      box-sizing: border-box;
      padding: 28px 24px;
      margin-bottom: 18px;
      border: 2px dashed rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      height: auto;
      overflow: visible;
    }
    .upload-zone * {
      max-width: 100%;
      box-sizing: border-box;
    }
    .upload-zone h3, .upload-zone p {
      margin-left: auto;
      margin-right: auto;
      text-align: center;
      overflow-wrap: break-word;
      word-break: break-all;
    }

    .upload-zone::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
      transition: left 0.5s;
    }

    .upload-zone:hover {
      border-color: rgba(102, 126, 234, 0.5);
      background: rgba(102, 126, 234, 0.05);
    }

    .upload-zone:hover::before {
      left: 100%;
    }

    .upload-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 16px;
      color: #667eea;
      opacity: 0.8;
    }

    /* æŒ‰é’®ç³»ç»Ÿ */
    .btn {
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
      cursor: pointer;
      border: none;
      position: relative;
      overflow: hidden;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn-primary {
      background: #007AFF;
      color: #fff;
      border: none;
      transition: background 0.2s;
    }

    .btn-primary:hover {
      background: #0051A8;
    }

    .btn-secondary {
      background: #F2F2F7;
      color: #007AFF;
      border: 1px solid #D1D1D6;
    }

    .btn-secondary:hover {
      background: #E5E5EA;
    }

    .btn-success {
      background: #34C759;
      color: #fff;
      border: none;
    }

    .btn-danger {
      background: #FF3B30;
      color: #fff;
      border: none;
    }
    .btn-danger:hover {
      background: #C1271A;
    }

    /* æ‘„åƒå¤´å¡ç‰‡ */
    .camera-card {
      width: 100%;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      background: rgba(255,255,255,0.08);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.1);
      padding: 14px 18px;
      margin: 0;
    }

    .card-main {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-actions {
      display: flex;
      gap: 12px;
      margin-top: 8px;
      border-top: 1px solid rgba(255,255,255,0.08);
      padding-top: 8px;
      align-items: center;
      width: 100%;
    }

    .camera-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
      transition: left 0.5s;
    }

    .camera-card:hover {
      transform: translateY(-4px);
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(102, 126, 234, 0.3);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
    }

    .camera-card:hover::before {
      left: 100%;
    }

    .camera-name {
      font-size: 16px;
      font-weight: 800;
      color: #ffffff;
      margin-bottom: 0;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .camera-location {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 12px;
    }

    .camera-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-online {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .status-offline {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .status-maintenance {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    /* å³ä¸Šè§’æ§åˆ¶é¢æ¿ */
    .control-panel {
      position: fixed;
      top: 24px;
      right: 24px;
      z-index: 30;
      display: flex;
      gap: 16px;
    }

    .control-btn {
      padding: 14px 20px;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      color: rgba(255, 255, 255, 0.9);
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .control-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(102, 126, 234, 0.3);
      transform: translateY(-2px);
    }

    /* æ¨¡æ€æ¡†è®¾è®¡ */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      backdrop-filter: blur(0.5px);
      z-index: 50;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .modal-content {
      width: 100%;
      max-width: 800px;
      max-height: 90vh;
      background: rgba(26, 26, 26, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      overflow: hidden;
      position: relative;
    }

    .modal-header {
      padding: 32px 32px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    }

    .modal-title {
      font-size: 24px;
      font-weight: 800;
      color: #ffffff;
      margin: 0;
      letter-spacing: -0.02em;
    }

    .modal-body {
      padding: 32px;
      max-height: 60vh;
      overflow-y: auto;
    }

    /* è¾“å…¥æ¡†è®¾è®¡ */
    .input-field {
      width: 100%;
      padding: 16px 20px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: #ffffff;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .input-field:focus {
      outline: none;
      border-color: rgba(102, 126, 234, 0.5);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      background: rgba(255, 255, 255, 0.08);
    }

    .input-field::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    .label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.8);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* æ»‘å—è®¾è®¡ */
    .slider {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      outline: none;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: var(--primary-gradient);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: var(--primary-gradient);
      border-radius: 50%;
      cursor: pointer;
      border: none;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    /* æŠ½å±‰è®¾è®¡ */
    .drawer {
      position: fixed;
      top: 0;
      right: 0;
      width: 400px;
      height: 100vh;
      background: rgba(26, 26, 26, 0.95);
      backdrop-filter: blur(20px);
      border-left: 1px solid rgba(255, 255, 255, 0.1);
      transform: translateX(100%);
      transition: transform 0.3s ease;
      z-index: 40;
      overflow-y: auto;
    }

    .drawer.open {
      transform: translateX(0);
    }

    .drawer-header {
      padding: 32px 24px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    }

    .drawer-title {
      font-size: 20px;
      font-weight: 700;
      color: #ffffff;
      margin: 0;
    }

    .drawer-content {
      padding: 24px;
    }

    /* å…³é—­æŒ‰é’® */
    .close-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 50%;
      color: rgba(255, 255, 255, 0.6);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .close-btn:hover {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      transform: rotate(90deg);
    }

    /* é¢„è§ˆåŒºåŸŸ */
    .preview-area {
      width: 100%;
      height: 120px;
      background: rgba(255, 255, 255, 0.03);
      border: 2px dashed rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .preview-area:hover {
      border-color: rgba(102, 126, 234, 0.3);
      background: rgba(102, 126, 234, 0.05);
    }

    .preview-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 8px;
    }

    /* ç»“æœæ¡†æ ·å¼ */
    .result-box {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      min-height: 100px;
      white-space: pre-wrap;
      font-family: 'Inter', monospace;
      font-size: 14px;
      line-height: 1.6;
      color: rgba(255, 255, 255, 0.9);
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 1200px) {
      .sidebar {
        width: 320px;
      }
    }

    @media (max-width: 768px) {
      .sidebar {
        position: absolute;
        width: calc(100vw - 48px);
        max-width: 360px;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .control-panel {
        top: 20px;
        right: 20px;
        gap: 12px;
      }

      .control-btn {
        padding: 12px 16px;
        font-size: 13px;
      }

      .drawer {
        width: 100vw;
      }
    }

    /* æ»šåŠ¨æ¡æ ·å¼ */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* åŠ¨ç”»æ•ˆæœ */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }

    .animate-fade-in-up {
      animation: fadeInUp 0.6s ease-out;
    }

    .animate-pulse {
      animation: pulse 2s infinite;
    }

    /* åŠ è½½çŠ¶æ€ */
    .loading {
      position: relative;
    }

    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .hidden {
      display: none !important;
    }

    .card-actions .btn {
      flex: 1;
      height: 40px;
      border-radius: 12px;
      font-size: 15px;
      background: #007AFF !important;
      color: #fff !important;
      box-shadow: none !important;
    }

    .card-actions .btn-danger {
      background: #FF3B30 !important;
      color: #fff !important;
    }

    .card-actions .camera-status {
      margin-left: 16px;
      flex-shrink: 0;
    }

    /* åŸºç¡€markdownç¾åŒ– */
    .result-box h1, .result-box h2, .result-box h3 {
      color: #007AFF;
      font-weight: 800;
      margin: 12px 0 8px 0;
    }
    .result-box ul, .result-box ol {
      margin: 8px 0 8px 18px;
      padding-left: 18px;
    }
    .result-box li {
      margin-bottom: 4px;
      line-height: 1.7;
    }
    .result-box strong {
      color: #222;
      font-weight: 700;
    }
    .result-box table {
      border-collapse: collapse;
      width: 100%;
      margin: 10px 0;
      background: rgba(255,255,255,0.95);
      color: #222;
      border-radius: 8px;
      overflow: hidden;
    }
    .result-box th, .result-box td {
      border: 1px solid #e5e7eb;
      padding: 6px 12px;
      text-align: left;
    }
    .result-box blockquote {
      border-left: 4px solid #007AFF;
      background: rgba(0,122,255,0.06);
      margin: 8px 0;
      padding: 8px 16px;
      color: #222;
      border-radius: 6px;
    }
    .result-box code {
      background: #f4f4f4;
      color: #007AFF;
      border-radius: 4px;
      padding: 2px 6px;
      font-size: 13px;
    }
    .result-box pre code {
      display: block;
      padding: 12px;
      background: #f4f4f4;
      color: #007AFF;
      border-radius: 8px;
      font-size: 13px;
      overflow-x: auto;
    }

    .result-box, .result-box * {
      color: #fff !important;
    }
    .result-box table {
      background: rgba(30,32,40,0.92);
      color: #fff !important;
    }
    .result-box th, .result-box td {
      color: #fff !important;
      border: 1px solid #3a3a3a;
    }
    .result-box blockquote {
      color: #fff !important;
    }
    .result-box code, .result-box pre code {
      color: #fff !important;
      background: #232946;
    }
    .result-box ul, .result-box ol {
      list-style-type: disc;
      color: #fff !important;
    }
    .result-box ul li::marker,
    .result-box ol li::marker {
      color: #fff !important;
      font-size: 1.1em;
    }
    .result-box th, .result-box td {
      border: 1px solid #bfc4cc !important;
    }
    .result-box blockquote {
      border-left: 4px solid #fff !important;
    }

    .geo-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 10px 12px;
      margin: 10px 0 0 0;
    }
    .geo-tag {
      background: rgba(0,122,255,0.12);
      color: #fff;
      border-radius: 8px;
      padding: 4px 12px;
      font-size: 13px;
      font-weight: 500;
      border: 1px solid #007AFF33;
      box-shadow: 0 2px 8px #0002;
      white-space: nowrap;
      margin-bottom: 2px;
    }
    .geo-tag b {
      color: #60a5fa;
      font-weight: 700;
    }
  </style>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-image/leaflet-image.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
  <!-- æ‘„åƒå¤´iconé«˜äº®æ ·å¼ -->
  <style>
    .camera-marker-glow img, .camera-marker-glow svg { filter: brightness(1.25) drop-shadow(0 0 10px #007affcc) drop-shadow(0 0 2px #fff); }
  </style>
</head>
<body>
  <!-- åœ°å›¾èƒŒæ™¯ -->
  <div id="map"></div>
  <!-- åœ°å›¾æ·±è‰²é®ç½© -->
  <div id="map-mask" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100vw; height: 100vh; background: rgba(10,10,20,0.18); z-index: 1; pointer-events: none; transition: opacity 0.3s;"></div>

  <!-- ä¾§è¾¹æ  -->
  <aside class="sidebar glass-card">
    <div class="sidebar-header">
      <h1 class="sidebar-title" style="font-size:2.2rem;font-weight:900;letter-spacing:-0.03em;color:#ffffff;background:none;-webkit-text-fill-color:#ffffff;-webkit-background-clip:unset;">VISION+</h1>
      <p class="sidebar-subtitle" style="font-size:1.18rem;font-weight:700;color:rgba(255,255,255,0.82);margin-top:8px;">ç‚¹ä½åœºæ™¯AIè¯†åˆ«demo</p>
    </div>
    <div class="sidebar-content">
      <!-- ä¸Šä¼ åŒºåŸŸ -->
      <div class="upload-zone" id="upload-zone">
        <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
        </svg>
        <h3 style="color: rgba(255,255,255,0.95); font-size: 20px; font-weight: 800; margin: 0 0 8px 0;">ğŸ‘€ä¸Šä¼ æ•°æ®æ–‡ä»¶</h3>
        <p style="color: rgba(255,255,255,0.6); font-size: 13px; margin: 0 0 20px 0;">æ”¯æŒ Excel (.xlsx/.xls) æˆ– CSV æ ¼å¼</p>
        <div style="display: flex; gap: 12px; justify-content: center;">
          <input type="file" id="excel-upload" accept=".xlsx,.xls" class="hidden" />
          <button onclick="document.getElementById('excel-upload').click()" class="btn btn-primary" style="padding: 8px 16px; font-size: 12px;">
            Excel
          </button>
          <input type="file" id="csv-upload" accept=".csv" class="hidden" />
          <button onclick="document.getElementById('csv-upload').click()" class="btn btn-secondary" style="padding: 8px 16px; font-size: 12px;">
            CSV
          </button>
        </div>
      </div>
      <!-- æ‘„åƒå¤´åˆ—è¡¨ -->
      <h3 style="color: rgba(255,255,255,0.8); font-size: 14px; font-weight: 600; margin: 0 0 16px 0; text-transform: uppercase; letter-spacing: 0.5px; padding: 0 8px;">æ‘„åƒå¤´åˆ—è¡¨</h3>
      <div id="camera-list" class="camera-list" style="padding-right: 8px;"></div>
    </div>
  </aside>

  <!-- å³ä¸Šè§’æ§åˆ¶é¢æ¿ -->
  <div class="control-panel">
    <button id="toggle-analysis" class="control-btn">
      <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
      </svg>
      AI åˆ†æ
    </button>
    <button onclick="openAddCameraModal()" class="control-btn">
      <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
      </svg>
      æ·»åŠ æ‘„åƒå¤´
    </button>
  </div>

  <!-- AIåˆ†ææ¨¡æ€æ¡† -->
  <div id="ai-modal" class="modal hidden">
    <div class="modal-content" id="modal-content">
      <button onclick="closeModal()" class="close-btn">Ã—</button>
      
      <div class="modal-header">
        <h2 class="modal-title">AI æ‘„åƒå¤´åˆ†æ</h2>
      </div>

      <div class="modal-body">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
          <div>
            <label class="label">æ‘„åƒå¤´åç§°</label>
            <input type="text" id="camera-name" class="input-field" placeholder="è¾“å…¥æ‘„åƒå¤´åç§°" />
          </div>
          <div>
            <label class="label">å›½æ ‡ç¼–ç </label>
            <input type="text" id="camera-code" class="input-field" placeholder="å¯é€‰" />
          </div>
        </div>
        <div style="margin-bottom: 24px;">
          <label class="label">æ‘„åƒå¤´ç”»é¢</label>
          <div style="display: flex; gap: 24px; align-items: flex-start;">
            <div class="preview-area" style="width: 200px; height: 120px; cursor: pointer;" onclick="document.getElementById('camera-upload').click()">
              <input type="file" id="camera-upload" accept="image/*" class="hidden" />
              <div id="camera-placeholder" style="text-align: center;">
                <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: rgba(255,255,255,0.4); margin-bottom: 8px;">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <span style="color: rgba(255,255,255,0.4); font-size: 12px;">ç‚¹å‡»ä¸Šä¼ </span>
              </div>
              <img id="camera-preview" class="preview-image hidden" />
            </div>
            <div style="flex: 1; display: flex; flex-direction: column; gap: 12px;">
              <button id="import-camera-btn" class="btn btn-secondary" style="width: 100%; height: 48px; display: flex; align-items: center; justify-content: center;">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 8px;">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                å¹³å°å¯¼å…¥ç”»é¢
              </button>
              <p style="color: rgba(255,255,255,0.4); font-size: 12px; margin: 0;">å¯é€šè¿‡å›½æ ‡ç¼–ç è‡ªåŠ¨è·å–ç”»é¢</p>
            </div>
          </div>
        </div>

        <div style="margin-bottom: 24px;">
          <label class="label">åœ°å›¾åŒºåŸŸè®¾ç½®</label>
          <div style="display: flex; gap: 24px; align-items: flex-start;">
            <div class="preview-area" style="width: 200px; height: 120px; position: relative;">
              <canvas id="map-canvas" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"></canvas>
              <img id="map-preview" class="preview-image hidden" />
              <input type="file" id="map-upload" accept="image/*" class="hidden" />
            </div>
            <div style="flex: 1; display: flex; flex-direction: column; gap: 12px;">
              <div style="display: flex; gap: 12px;">
                <button id="screenshot-btn" class="btn btn-secondary" style="flex: 1; height: 48px;">ç”Ÿæˆåœ°å›¾æˆªå›¾</button>
                <button onclick="document.getElementById('map-upload').click()" class="btn btn-primary" style="flex: 1; height: 48px;">ä¸Šä¼ åœ°å›¾</button>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 8px;">
                <div>
                  <label class="label" style="font-size: 11px;">è§†é‡è§’åº¦</label>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="range" id="angle-slider" min="30" max="120" value="60" class="slider" style="flex: 1;" />
                    <span id="angle-value" style="color: rgba(255,255,255,0.6); font-size: 12px; min-width: 35px;">60Â°</span>
                  </div>
                </div>
                <div>
                  <label class="label" style="font-size: 11px;">è§†é‡è·ç¦»</label>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="range" id="radius-slider" min="20" max="100" value="30" class="slider" style="flex: 1;" />
                    <span id="radius-value" style="color: #e0e6ff; font-size: 14px; font-weight: 700; min-width: 35px;">30m</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div style="margin-bottom: 24px;">
            <label class="label">åˆ†ææ¨¡å‹</label>
            <select id="ai-model-select" class="input-field">
              <option value="qwen">Qwen2.5-VL-32B-Instructï¼ˆé»˜è®¤ï¼‰</option>
              <option value="stepfun">é˜¶è·ƒæ˜Ÿè¾° step-1o-turbo-vision</option>
            </select>
          </div>
          <div style="margin-bottom: 24px;">
            <label class="label">åˆ†ææç¤ºè¯</label>
            <textarea id="prompt-text" class="input-field" style="min-height: 120px; resize: vertical; font-family: 'Inter', monospace; font-size: 13px;" placeholder="è¾“å…¥AIåˆ†ææç¤ºè¯...">ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„åŸå¸‚æ²»ç†AIå›¾åƒåˆ†æå¸ˆã€‚è¯·åŸºäºä»¥ä¸‹ä¿¡æ¯ï¼Œç»“åˆæ‘„åƒå¤´ç”»é¢å’Œå¹³é¢å›¾çš„å…ƒç´ ï¼Œåˆ¤æ–­æ‘„åƒå¤´æ‰€åœ¨åŒºåŸŸç±»å‹ã€æ˜“å‘äº‹ä»¶å’Œåœºæ‰€ç±»å‹ï¼Œå¹¶ç»™å‡ºç®€è¦åˆ†æã€‚
  
  ã€æ‘„åƒå¤´ä¿¡æ¯ã€‘
  - åç§°ï¼š{name}
  - å›½æ ‡ç¼–ç ï¼š{code}
  - åŒºåŸŸï¼š{area}
  - ç‰‡åŒºï¼š{section}
  - å»ºç­‘ç‰©ï¼š{building}
  - æ¥¼å±‚ï¼š{floor}
  - åœºæ‰€ç±»å‹ï¼š{placeType}
  - ç›¸å¯¹åœºæ‰€ä½ç½®ä¿¡æ¯ï¼š{relativePlace}
  - å…·ä½“åœºæ‰€ä½ç½®ä¿¡æ¯ï¼š{specificPlace}
  - ç»†èŠ‚å¤‡æ³¨ï¼š{detail}
  
  ã€åˆ†æä»»åŠ¡ã€‘
  1. åˆ¤æ–­è¯¥æ‘„åƒå¤´æ‰€åœ¨çš„åŒºåŸŸç±»å‹ï¼ˆå¦‚é“è·¯ã€åœè½¦åœºã€åœ°é“å£ã€å…¬äº¤ç«™ç­‰ï¼‰ã€‚
  2. ç»“åˆåœ°ç†æ ‡ç­¾å’Œç”»é¢ï¼Œæ¨æµ‹æ˜“å‘åŸå¸‚æ²»ç†äº‹ä»¶ï¼ˆå¦‚è¿åœã€æ‹¥å µã€äººå‘˜èšé›†ç­‰ï¼‰ã€‚
  3. ç®€è¦è¯´æ˜åœºæ‰€ç±»å‹å’Œç›‘æ§é‡ç‚¹ã€‚
  
  ã€è¾“å‡ºæ ¼å¼ã€‘
  - åŒºåŸŸç±»å‹ï¼š
  - æ˜“å‘äº‹ä»¶ï¼š
  - åœºæ‰€ç±»å‹åˆ¤æ–­ï¼š
  - åˆ†æè¯´æ˜ï¼š
  ï¼ˆè¯·è¾“å‡ºä¸è¶…è¿‡300å­—ï¼‰</textarea>
        <div style="margin-bottom: 32px;">
          <label class="label">AI åˆ†æç»“æœ</label>
          <div id="result-box" class="result-box">ç‚¹å‡»"å¼€å§‹åˆ†æ"æŒ‰é’®è·å–AIåˆ†æç»“æœ...</div>
        </div>

        <div style="display: flex; justify-content: flex-end; gap: 16px; padding-top: 24px; border-top: 1px solid rgba(255,255,255,0.1);">
          <button onclick="closeModal()" class="btn btn-secondary">å–æ¶ˆ</button>
          <button id="save-btn" class="btn btn-success">ä¿å­˜æ‘„åƒå¤´</button>
          <button id="analyze-btn" class="btn btn-primary">å¼€å§‹åˆ†æ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ·»åŠ æ‘„åƒå¤´æ¨¡æ€æ¡† -->
  <div id="add-camera-modal" class="modal hidden">
    <div class="modal-content" style="max-width: 500px;">
      <button onclick="closeAddCameraModal()" class="close-btn">Ã—</button>
      
      <div class="modal-header">
        <h2 class="modal-title">æ·»åŠ æ–°æ‘„åƒå¤´</h2>
      </div>

      <div class="modal-body">
        <div style="display: flex; flex-direction: column; gap: 20px;">
          <div><label class="label">æ‘„åƒå¤´åç§°</label><input id="add-name" type="text" class="input-field" placeholder="è¾“å…¥æ‘„åƒå¤´åç§°" /></div>
          <div><label class="label">å›½æ ‡ç¼–ç ï¼ˆå¯é€‰ï¼‰</label><input id="add-code" type="text" class="input-field" placeholder="è¾“å…¥å›½æ ‡ç¼–ç " /></div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div><label class="label">ç»åº¦</label><input id="add-lng" type="number" class="input-field" placeholder="å¦‚: 114.213" step="any" /></div>
            <div><label class="label">çº¬åº¦</label><input id="add-lat" type="number" class="input-field" placeholder="å¦‚: 22.699" step="any" /></div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div><label class="label">åŒºåŸŸ</label><input id="add-area" type="text" class="input-field" placeholder="å¦‚: å¤§è¿ä¸­å¿ƒåŒºåŸŸ" /></div>
            <div><label class="label">ç‰‡åŒº</label><input id="add-section" type="text" class="input-field" placeholder="å¦‚: å‘¨è¾¹é“è·¯ç‰‡åŒº" /></div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div><label class="label">å»ºç­‘ç‰©</label><input id="add-building" type="text" class="input-field" placeholder="å¦‚: é¾™é£å¤§é“å‘¨è¾¹" /></div>
            <div><label class="label">æ¥¼å±‚</label><input id="add-floor" type="text" class="input-field" placeholder="å¦‚: å¤§è¿ä¸­å¿ƒä½“è‚²é¦†..." /></div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div><label class="label">åœºæ‰€ç±»å‹</label><input id="add-placeType" type="text" class="input-field" placeholder="å¦‚: åœ°ä¸Šåœè½¦åœº" /></div>
            <div><label class="label">ç›¸å¯¹åœºæ‰€ä½ç½®ä¿¡æ¯</label><input id="add-relativePlace" type="text" class="input-field" placeholder="å¦‚: Då£" /></div>
          </div>
          <div><label class="label">å…·ä½“åœºæ‰€ä½ç½®ä¿¡æ¯</label><input id="add-specificPlace" type="text" class="input-field" placeholder="å¦‚: å‡ºå…¥å£" /></div>
          <div><label class="label">ç»†èŠ‚å¤‡æ³¨</label><input id="add-detail" type="text" class="input-field" placeholder="å¦‚: å¤‡æ³¨ä¿¡æ¯" /></div>
        </div>

        <div style="display: flex; justify-content: flex-end; gap: 16px; margin-top: 32px; padding-top: 24px; border-top: 1px solid rgba(255,255,255,0.1);">
          <button onclick="closeAddCameraModal()" class="btn btn-secondary">å–æ¶ˆ</button>
          <button onclick="addCameraByForm()" class="btn btn-primary">æ·»åŠ æ‘„åƒå¤´</button>
        </div>
      </div>
    </div>
  </div>

  <!-- AIåˆ†ææŠ½å±‰ -->
  <div id="ai-drawer" class="drawer">
    <div class="drawer-header">
      <h2 class="drawer-title">AI åˆ†æç»“æœ</h2>
      <button id="close-analysis" class="close-btn" style="position: absolute; top: 20px; right: 20px;">Ã—</button>
    </div>
    <div class="drawer-content">
      <div id="drawer-result-box" class="result-box" style="min-height: calc(100vh - 200px);">
        è¯·é€‰æ‹©æ‘„åƒå¤´å¹¶ç‚¹å‡»åˆ†ææŒ‰é’®åæŸ¥çœ‹ç»“æœ...
      </div>
    </div>
  </div>

  <script>
    // å…¨å±€å˜é‡
    let cameraList = [
      {
        code: '44030783001320002230',
        name: 'é¾™é£å¤§é“ä½“è‚²åœºDå£åœè½¦åœºå‡ºå…¥å£',
        area: 'å¤§è¿ä¸­å¿ƒåŒºåŸŸ',
        section: 'å‘¨è¾¹é“è·¯ç‰‡åŒº',
        building: 'é¾™é£å¤§é“å‘¨è¾¹',
        floor: 'å¤§è¿ä¸­å¿ƒä½“è‚²é¦†é¾™é£å¤§é“å…¥å£æ®µ-é’æ˜¥è·¯æ®µ',
        placeType: 'åœ°ä¸Šåœè½¦åœº',
        relativePlace: 'Då£',
        specificPlace: 'å‡ºå…¥å£',
        detail: '',
        realName: '',
        type: 'æª',
        lng: 114.211253,
        lat: 22.695207,
        status: 'online'
      },
      {
        code: '44030783001320002229',
        name: 'é¾™é£å¤§é“ä½“è‚²åœºå……ç”µæ¡©å¤–å…¬äº¤ç«™',
        area: 'å¤§è¿ä¸­å¿ƒåŒºåŸŸ',
        section: 'å‘¨è¾¹é“è·¯ç‰‡åŒº',
        building: 'é¾™é£å¤§é“å‘¨è¾¹',
        floor: 'å¤§è¿ä¸­å¿ƒä½“è‚²é¦†é¾™é£å¤§é“å…¥å£æ®µ-é’æ˜¥è·¯æ®µ',
        placeType: 'æ¸¯ä¸­å¤§æ·±åœ³æ ¡åŒºå…¬äº¤ç«™å°',
        relativePlace: 'å……ç”µæ¡©å¤–',
        specificPlace: 'è¥¿',
        detail: 'é¦™æ¸¯ä¸­æ–‡å¤§å­¦(æ·±åœ³)å¯¹é¢',
        realName: '',
        type: 'çƒ',
        lng: 114.212078,
        lat: 22.694367,
        status: 'online'
      },
      {
        code: '44030783001320002136',
        name: 'é¾™é£å¤§é“ä½“è‚²åœºå……ç”µæ¡©åœè½¦åœº2',
        area: 'å¤§è¿ä¸­å¿ƒåŒºåŸŸ',
        section: 'å‘¨è¾¹é“è·¯ç‰‡åŒº',
        building: 'é¾™é£å¤§é“å‘¨è¾¹',
        floor: 'å¤§è¿ä¸­å¿ƒä½“è‚²é¦†é¾™é£å¤§é“å…¥å£æ®µ-é’æ˜¥è·¯æ®µ',
        placeType: 'åœ°ä¸Šåœè½¦åœº',
        relativePlace: 'å……ç”µæ¡©',
        specificPlace: 'é æ¹–è¾¹',
        detail: '',
        realName: '',
        type: 'æª',
        lng: 114.212507,
        lat: 22.694162,
        status: 'online'
      },
      {
        code: '44030783001320002135',
        name: 'é¾™é£å¤§é“å……ç”µæ¡©åœè½¦åœº1',
        area: 'å¤§è¿ä¸­å¿ƒåŒºåŸŸ',
        section: 'å‘¨è¾¹é“è·¯ç‰‡åŒº',
        building: 'é¾™é£å¤§é“å‘¨è¾¹',
        floor: 'å¤§è¿ä¸­å¿ƒä½“è‚²é¦†é¾™é£å¤§é“å…¥å£æ®µ-é’æ˜¥è·¯æ®µ',
        placeType: 'åœ°ä¸Šåœè½¦åœº',
        relativePlace: 'å……ç”µæ¡©',
        specificPlace: 'é æ¹–è¾¹',
        detail: '',
        realName: '',
        type: 'çƒ',
        lng: 114.212550,
        lat: 22.694181,
        status: 'online'
      },
      {
        code: '44030783001320002228',
        name: 'é¾™ç¿”å¤§é“å¾€é¾™é£å¤§é“æ‹å¼¯å¤„',
        area: 'å¤§è¿ä¸­å¿ƒåŒºåŸŸ',
        section: 'å‘¨è¾¹é“è·¯ç‰‡åŒº',
        building: 'é¾™ç¿”å¤§é“å‘¨è¾¹',
        floor: 'å¤§è¿ä¸­å¿ƒä½“è‚²é¦†å—å¹¿åœº-é¾™é£å¤§é“æ®µ',
        placeType: 'äººè¡Œé“',
        relativePlace: 'æ‹è§’å¤„',
        specificPlace: 'å—',
        detail: '',
        realName: '',
        type: 'çƒ',
        lng: 114.213011,
        lat: 22.694105,
        status: 'online'
      },
      {
        code: '44030783001320003007',
        name: 'äº‘å¤©åŠ±é£_å¤§è¿åŸæ‰€_å¤§è¿ä¸­å¿ƒå…¬äº¤ç«™',
        area: 'å¤§è¿ä¸­å¿ƒåŒºåŸŸ',
        section: 'å‘¨è¾¹é“è·¯ç‰‡åŒº',
        building: 'å¤§è¿è·¯å‘¨è¾¹',
        floor: 'å¤§è¿è·¯-éº¦å½“åŠ³æ®µ',
        placeType: 'å¤§è¿ä¸­å¿ƒå…¬äº¤ç«™å°',
        relativePlace: 'å—å¹¿åœº',
        specificPlace: 'å‡ºå…¥å£',
        detail: '',
        realName: '',
        type: 'æª',
        lng: 114.214495,
        lat: 22.695675,
        status: 'online'
      },
      {
        code: '44030783001320002682',
        name: 'ï¼ˆäººåƒï¼‰é¾™ç¿”å¤§é“äººè¡Œåœ°é“Bå‡ºå…¥å£',
        area: 'å¤§è¿ä¸­å¿ƒåŒºåŸŸ',
        section: 'å‘¨è¾¹é“è·¯ç‰‡åŒº',
        building: 'é¾™ç¿”å¤§é“å‘¨è¾¹',
        floor: 'å¤§è¿ä¸­å¿ƒä½“è‚²é¦†å—å¹¿åœº-é¾™é£å¤§é“æ®µ',
        placeType: 'åœ°ä¸Šåœè½¦åœº',
        relativePlace: 'Bå‡ºå…¥å£',
        specificPlace: '',
        detail: '',
        realName: '',
        type: 'æª',
        lng: 114.213554,
        lat: 22.694840,
        status: 'online'
      },
      {
        code: '44030783001320002227',
        name: 'é¾™ç¿”å¤§é“ä½“è‚²åœºå……ç”µæ¡©åœè½¦åœºå…¥å£',
        area: 'å¤§è¿ä¸­å¿ƒåŒºåŸŸ',
        section: 'å‘¨è¾¹é“è·¯ç‰‡åŒº',
        building: 'é¾™ç¿”å¤§é“å‘¨è¾¹',
        floor: 'å¤§è¿ä¸­å¿ƒä½“è‚²é¦†å—å¹¿åœº-é¾™é£å¤§é“æ®µ',
        placeType: 'åœ°ä¸Šåœè½¦åœº',
        relativePlace: 'å……ç”µæ¡©',
        specificPlace: 'é¾™ç¿”å¤§é“å…¥å£',
        detail: '',
        realName: '',
        type: 'çƒ',
        lng: 114.213529,
        lat: 22.694785,
        status: 'online'
      },
      {
        code: '44030783001320002225',
        name: 'é»„é˜è·¯å¤§è¿ä¸­å¿ƒåœ°é“ç«™Då‡ºå£1',
        area: 'å¤§è¿ä¸­å¿ƒåŒºåŸŸ',
        section: 'å‘¨è¾¹é“è·¯ç‰‡åŒº',
        building: 'å¤§è¿è·¯å‘¨è¾¹',
        floor: 'å¤§è¿è·¯-éº¦å½“åŠ³æ®µ',
        placeType: 'åœ°é“å£',
        relativePlace: 'Då£',
        specificPlace: 'å‡ºå…¥å£1',
        detail: 'å¯æ­¥è¡Œè‡³æ¼”å”±ä¼šåœºé¦†å†…åœºdå£ã€çœ‹å°ã€ä¸»å¸­å°åŒ…å¢å’Œä¸œè¥¿åŒ…å¢ï¼ˆæ¼”å”±ä¼šé‡è¦ç‚¹ä½ï¼‰',
        realName: '',
        type: 'æª',
        lng: 114.215909,
        lat: 22.697343,
        status: 'online'
      }
    ];
    let map;
    let viewCone = null;
    let areaBox = null;
    let currentCamera = null;
    let markers = [];

    // æ‘„åƒå¤´å›¾æ ‡
    const cameraIcon = L.icon({
      iconUrl: 'data:image/svg+xml;utf8,<svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><ellipse cx="24" cy="40" rx="8" ry="3" fill="%23007AFF" opacity="0.18"/><path d="M24 6C16.82 6 11 11.82 11 19C11 28.25 22.13 40.13 23.13 41.18C23.6 41.68 24.4 41.68 24.87 41.18C25.87 40.13 37 28.25 37 19C37 11.82 31.18 6 24 6ZM24 24C21.24 24 19 21.76 19 19C19 16.24 21.24 14 24 14C26.76 14 29 16.24 29 19C29 21.76 26.76 24 24 24Z" fill="%23007AFF"/><circle cx="24" cy="19" r="5" fill="white"/><circle cx="24" cy="19" r="3" fill="%23007AFF"/></svg>',
      iconSize: [48, 48],
      iconAnchor: [24, 48],
      popupAnchor: [0, -48],
      className: 'camera-marker camera-marker-glow'
    });

    // åˆå§‹åŒ–åœ°å›¾
    function initMap() {
      map = L.map('map').setView([22.699, 114.213], 16);
      L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
        maxZoom: 20,
        attribution: ''
      }).addTo(map);
    }

    // æ›´æ–°æ‘„åƒå¤´åˆ—è¡¨æ˜¾ç¤º
    function updateCameraList() {
      const container = document.getElementById('camera-list');
      container.innerHTML = '';

      if (cameraList.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px 20px; color: rgba(255,255,255,0.4);">
            <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 16px; opacity: 0.5;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
            <p style="margin: 0; font-size: 14px;">æš‚æ— æ‘„åƒå¤´æ•°æ®</p>
            <p style="margin: 8px 0 0 0; font-size: 12px;">è¯·ä¸Šä¼ Excelæˆ–CSVæ–‡ä»¶</p>
          </div>
        `;
        return;
      }

      cameraList.forEach((cam, index) => {
        const div = document.createElement('div');
        div.className = 'camera-card animate-fade-in-up';
        div.onclick = () => focusCameraOnMap(index);
        div.innerHTML = `
          <div class="card-main">
            <div class="camera-name">${cam.name}</div>
            <span class="camera-status ${
              cam.status === 'online' ? 'status-online' :
              cam.status === 'offline' ? 'status-offline' :
              'status-maintenance'
            }">${
              cam.status === 'online' ? 'åœ¨çº¿' :
              cam.status === 'offline' ? 'ç¦»çº¿' : 'ç»´æŠ¤'
            }</span>
          </div>
          <div class="camera-location" style="margin-bottom:2px;">
            <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: inline-block; margin-right: 4px;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 12.414a4 4 0 10-1.414 1.414l4.243 4.243a1 1 0 001.414-1.414z"></path>
            </svg>
            ${cam.lat.toFixed(6)}, ${cam.lng.toFixed(6)}
          </div>
          <div class="card-actions">
            <button onclick="editCamera(${index}); event.stopPropagation();" class="btn btn-primary">ç¼–è¾‘</button>
            <button onclick="deleteCamera(${index}); event.stopPropagation();" class="btn btn-danger">åˆ é™¤</button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // æ›´æ–°åœ°å›¾æ ‡è®°
    function updateMapMarkers() {
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];

      cameraList.forEach((cam, index) => {
        const marker = L.marker([cam.lat, cam.lng], { icon: cameraIcon })
          .addTo(map)
          .bindPopup(`
            <div style="color: #1a1a1a; font-weight: 600;">${cam.name}</div>
            <div style="color: #666; font-size: 12px; margin-top: 4px;">${cam.lat.toFixed(6)}, ${cam.lng.toFixed(6)}</div>
          `)
          .on('click', () => editCamera(index));
        // é¼ æ ‡hoveræ—¶é«˜äº®æ˜¾ç¤ºçŸ©å½¢åŒºåŸŸ
        marker.on('mouseover', () => {
          if (window.markerHoverBox) map.removeLayer(window.markerHoverBox);
          if (window.markerGridLines) { window.markerGridLines.forEach(l=>map.removeLayer(l)); window.markerGridLines = null; }
          const bounds = getBounds30m(cam.lat, cam.lng);
          window.markerHoverBox = L.rectangle(bounds, {
            color: "#fff",
            fillColor: "#fff",
            weight: 3,
            fillOpacity: 0.10,
            opacity: 1,
            dashArray: "8,6"
          }).addTo(map);
          // è®¡ç®—å››ä¸ªè¾¹ä¸­ç‚¹ï¼Œå‘å¤–å»¶ä¼¸ç°è‰²çŸ¢é‡çº¿
          const ne = bounds.getNorthEast();
          const sw = bounds.getSouthWest();
          const nw = bounds.getNorthWest();
          const se = bounds.getSouthEast();
          // è®¡ç®—ä¸­ç‚¹
          const midTop = L.latLng(ne.lat, (ne.lng + nw.lng) / 2);
          const midBottom = L.latLng(sw.lat, (sw.lng + se.lng) / 2);
          const midLeft = L.latLng((nw.lat + sw.lat) / 2, nw.lng);
          const midRight = L.latLng((ne.lat + se.lat) / 2, ne.lng);
          // è®¡ç®—å»¶ä¼¸ç‚¹ï¼ˆå¤§çº¦40pxçš„åœ°ç†è·ç¦»ï¼ŒæŒ‰å½“å‰zoomåŠ¨æ€è®¡ç®—ï¼‰
          const pxLen = 40;
          const mapCRS = map.options.crs || L.CRS.EPSG3857;
          function extendFrom(latlng, dx, dy) {
            const p = map.latLngToLayerPoint(latlng);
            const p2 = L.point(p.x + dx, p.y + dy);
            return map.layerPointToLatLng(p2);
          }
          // ä¸Šã€ä¸‹ã€å·¦ã€å³
          const extTop = extendFrom(midTop, 0, -pxLen);
          const extBottom = extendFrom(midBottom, 0, pxLen);
          const extLeft = extendFrom(midLeft, -pxLen, 0);
          const extRight = extendFrom(midRight, pxLen, 0);
          // ç»˜åˆ¶å››æ¡çº¿
          window.markerGridLines = [
            L.polyline([midTop, extTop], {color:'#bfc4cc',weight:2,opacity:0.7,dashArray:'0'}).addTo(map),
            L.polyline([midBottom, extBottom], {color:'#bfc4cc',weight:2,opacity:0.7,dashArray:'0'}).addTo(map),
            L.polyline([midLeft, extLeft], {color:'#bfc4cc',weight:2,opacity:0.7,dashArray:'0'}).addTo(map),
            L.polyline([midRight, extRight], {color:'#bfc4cc',weight:2,opacity:0.7,dashArray:'0'}).addTo(map)
          ];
          // åœ¨åŒºåŸŸä¸­å¿ƒæ·»åŠ Area:30x30æ ‡ç­¾
          const nwLabel = bounds.getNorthWest();
          window.markerAreaLabel = L.marker(nwLabel, {
            icon: L.divIcon({
              className: '',
              html: `<div style="background:rgba(30,32,40,0.82);color:#fff;border-radius:8px;padding:2px 10px;font-size:13px;font-weight:600;box-shadow:0 2px 8px #0003;letter-spacing:0.04em;backdrop-filter:blur(2px);border:1.5px solid #fff;">Area:30Ã—30</div>`
            }),
            interactive: false
          }).addTo(map);
        });
        marker.on('mouseout', () => {
          if (window.markerHoverBox) {
            map.removeLayer(window.markerHoverBox);
            window.markerHoverBox = null;
          }
          if (window.markerGridLines) {
            window.markerGridLines.forEach(l=>map.removeLayer(l));
            window.markerGridLines = null;
          }
          if (window.markerAreaLabel) {
            map.removeLayer(window.markerAreaLabel);
            window.markerAreaLabel = null;
          }
        });
        markers.push(marker);
      });
    }

    // åœ°å›¾å®šä½åˆ°æ‘„åƒå¤´
    function focusCameraOnMap(index) {
      const cam = cameraList[index];
      if (!cam) return;
      map.setView([cam.lat, cam.lng], 18, { animate: true, duration: 1 });
      if (markers[index]) {
        markers[index].openPopup();
      }
    }

    // åˆ é™¤æ‘„åƒå¤´
    function deleteCamera(index) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ‘„åƒå¤´å—ï¼Ÿ')) {
        cameraList.splice(index, 1);
        updateCameraList();
        updateMapMarkers();
      }
    }

    // ç¼–è¾‘æ‘„åƒå¤´
    function editCamera(index) {
      currentCamera = { ...cameraList[index], index };
      openModal();
    }

    // åœ°å›¾ç›¸å…³å‡½æ•°
    function getBounds30m(lat, lng) {
      const latDiff = 30 / 111111;
      const lngDiff = 30 / (111111 * Math.cos(lat * Math.PI / 180));
      return L.latLngBounds([lat - latDiff, lng - lngDiff], [lat + latDiff, lng + lngDiff]);
    }

    function drawViewCone(lat, lng, heading, angle, radius) {
      if (viewCone) map.removeLayer(viewCone);
      const points = [[lat, lng]];
      for (let a = -angle / 2; a <= angle / 2; a += 3) {
        const rad = (heading + a) * Math.PI / 180;
        const dx = radius * Math.cos(rad) / 111111;
        const dy = radius * Math.sin(rad) / 111111;
        points.push([lat + dy, lng + dx]);
      }
      // å…ˆä¸addToï¼Œè¿”å›polygonå¯¹è±¡
      const cone = L.polygon(points, {
        color: "#fff",
        fillColor: "#fff",
        fillOpacity: 0.35,
        weight: 2,
        opacity: 0.9
      });
      viewCone = cone;
      // å…ˆä¸addToï¼Œäº¤ç”±å¤–éƒ¨æ§åˆ¶é¡ºåº
      cone.addTo(map);
      if (areaBox) {
        areaBox.bringToBack(); // ä¿è¯çŸ©å½¢åœ¨ä¸‹
        cone.bringToFront();   // æ‰‡å½¢åœ¨ä¸Š
      }
      return points;
    }

    function drawBoundsBox(bounds) {
      if (areaBox) map.removeLayer(areaBox);
      areaBox = L.rectangle(bounds, {
        color: "#fff",
        fillColor: "#60a5fa",
        weight: 4,
        fillOpacity: 0.18,
        opacity: 1,
        dashArray: "6,4"
      }).addTo(map);
      // é¢å¤–åŠ ä¸€ä¸ªåŠé€æ˜ç™½è‰²å†…é˜´å½±æ•ˆæœï¼ˆé€šè¿‡CSS hackï¼‰
      if (areaBox._path) {
        areaBox._path.style.filter = "drop-shadow(0 0 8px #fff8) drop-shadow(0 0 2px #60a5fa)";
      }
    }

    function getCombinedBounds(points, bounds) {
      const all = [...points, bounds.getNorthWest(), bounds.getSouthEast()];
      return L.latLngBounds(all);
    }

    function screenshotArea(bounds, callback) {
      const tempDiv = document.createElement("div");
      tempDiv.style.width = "512px";
      tempDiv.style.height = "512px";
      tempDiv.style.position = "absolute";
      tempDiv.style.top = "-1000px";
      document.body.appendChild(tempDiv);

      const tempMap = L.map(tempDiv, {
        zoomControl: false,
        attributionControl: false
      }).setView(bounds.getCenter(), 20);

      const layer = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
        maxZoom: 20
      }).addTo(tempMap);

      tempMap.fitBounds(bounds);

      layer.on("load", () => {
        setTimeout(() => {
          leafletImage(tempMap, function (err, canvas) {
            callback(canvas);
            tempMap.remove();
            document.body.removeChild(tempDiv);
          });
        }, 500);
      });
    }

    // æ›´æ–°åœ°å›¾æˆªå›¾
    function updateMapScreenshot(bounds) {
      screenshotArea(bounds, function(canvas) {
        const mapCanvas = document.getElementById("map-canvas");
        mapCanvas.width = canvas.width;
        mapCanvas.height = canvas.height;
        const ctx = mapCanvas.getContext("2d");
        ctx.clearRect(0, 0, mapCanvas.width, mapCanvas.height);
        ctx.drawImage(canvas, 0, 0);
      });
    }

    // é®ç½©æ§åˆ¶å‡½æ•°
    function showMapMask() {
      document.getElementById('map-mask').style.opacity = '1';
    }
    function hideMapMask() {
      document.getElementById('map-mask').style.opacity = '0';
    }

    // æ¨¡æ€æ¡†æ§åˆ¶
    function openModal() {
      if (!currentCamera) return;
      document.getElementById('camera-name').value = currentCamera.name || '';
      document.getElementById('camera-code').value = currentCamera.code || '';
      document.getElementById('ai-modal').classList.remove('hidden');
      // ä¾§è¾¹æ èšç„¦æ¸…æ™°
      document.querySelector('.sidebar').classList.add('focus-clear');
      const bounds = getBounds30m(currentCamera.lat, currentCamera.lng);
      drawBoundsBox(bounds);
      // å±•ç¤ºåœ°ç†æ ‡ç­¾ä¿¡æ¯
      let geoInfoHtml = `<div style="margin:16px 0 8px 0;padding:12px 16px;background:rgba(102,126,234,0.07);border-radius:12px;">
        <div style="font-weight:700;color:#667eea;margin-bottom:6px;">åœ°ç†æ ‡ç­¾ä¿¡æ¯</div>
        <div class="geo-tags">
          <span class="geo-tag"><b>åŒºåŸŸï¼š</b>${currentCamera.area || '-'}</span>
          <span class="geo-tag"><b>ç‰‡åŒºï¼š</b>${currentCamera.section || '-'}</span>
          <span class="geo-tag"><b>å»ºç­‘ç‰©ï¼š</b>${currentCamera.building || '-'}</span>
          <span class="geo-tag"><b>æ¥¼å±‚ï¼š</b>${currentCamera.floor || '-'}</span>
          <span class="geo-tag"><b>åœºæ‰€ç±»å‹ï¼š</b>${currentCamera.placeType || '-'}</span>
          <span class="geo-tag"><b>ç›¸å¯¹åœºæ‰€ä½ç½®ä¿¡æ¯ï¼š</b>${currentCamera.relativePlace || '-'}</span>
          <span class="geo-tag"><b>å…·ä½“åœºæ‰€ä½ç½®ä¿¡æ¯ï¼š</b>${currentCamera.specificPlace || '-'}</span>
          <span class="geo-tag"><b>ç»†èŠ‚å¤‡æ³¨ï¼š</b>${currentCamera.detail || '-'}</span>
        </div>
      </div>`;
      // æ’å…¥åˆ°å¼¹çª—å†…å®¹åˆé€‚ä½ç½®ï¼ˆå¦‚æ‘„åƒå¤´åç§°ä¸‹æ–¹ï¼‰
      const modalBody = document.querySelector('.modal-body');
      if (modalBody && !document.getElementById('geo-info-box')) {
        const geoDiv = document.createElement('div');
        geoDiv.id = 'geo-info-box';
        geoDiv.innerHTML = geoInfoHtml;
        modalBody.insertBefore(geoDiv, modalBody.children[1]);
      } else if (modalBody && document.getElementById('geo-info-box')) {
        document.getElementById('geo-info-box').innerHTML = geoInfoHtml;
      }
      // åŠ¨æ€å¡«å……åˆ†ææç¤ºè¯
      const promptTemplate = `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„åŸå¸‚æ²»ç†AIå›¾åƒåˆ†æå¸ˆã€‚è¯·åŸºäºä»¥ä¸‹ä¿¡æ¯ï¼Œç»“åˆæ‘„åƒå¤´ç”»é¢å’Œå¹³é¢å›¾çš„å…ƒç´ ï¼Œåˆ¤æ–­æ‘„åƒå¤´æ‰€åœ¨åŒºåŸŸç±»å‹ã€æ˜“å‘äº‹ä»¶å’Œåœºæ‰€ç±»å‹ï¼Œå¹¶ç»™å‡ºç®€è¦åˆ†æã€‚
  
  ã€æ‘„åƒå¤´ä¿¡æ¯ã€‘
  - åç§°ï¼š{name}
  - å›½æ ‡ç¼–ç ï¼š{code}
  - åŒºåŸŸï¼š{area}
  - ç‰‡åŒºï¼š{section}
  - å»ºç­‘ç‰©ï¼š{building}
  - æ¥¼å±‚ï¼š{floor}
  - åœºæ‰€ç±»å‹ï¼š{placeType}
  - ç›¸å¯¹åœºæ‰€ä½ç½®ä¿¡æ¯ï¼š{relativePlace}
  - å…·ä½“åœºæ‰€ä½ç½®ä¿¡æ¯ï¼š{specificPlace}
  - ç»†èŠ‚å¤‡æ³¨ï¼š{detail}
  
  ã€åˆ†æä»»åŠ¡ã€‘
  1. åˆ¤æ–­è¯¥æ‘„åƒå¤´æ‰€åœ¨çš„åŒºåŸŸç±»å‹ï¼ˆå¦‚é“è·¯ã€åœè½¦åœºã€åœ°é“å£ã€å…¬äº¤ç«™ç­‰ï¼‰ã€‚
  2. ç»“åˆåœ°ç†æ ‡ç­¾å’Œç”»é¢ï¼Œæ¨æµ‹æ˜“å‘åŸå¸‚æ²»ç†äº‹ä»¶ï¼ˆå¦‚è¿åœã€æ‹¥å µã€äººå‘˜èšé›†ç­‰ï¼‰ã€‚
  3. ç®€è¦è¯´æ˜åœºæ‰€ç±»å‹å’Œç›‘æ§é‡ç‚¹ã€‚
  
  ã€è¾“å‡ºæ ¼å¼ã€‘
  - åŒºåŸŸç±»å‹ï¼š
  - æ˜“å‘äº‹ä»¶ï¼š
  - åœºæ‰€ç±»å‹åˆ¤æ–­ï¼š
  - åˆ†æè¯´æ˜ï¼š
  ï¼ˆè¯·è¾“å‡ºä¸è¶…è¿‡300å­—ï¼‰`;
      const prompt = promptTemplate
        .replace('{name}', currentCamera.name || '')
        .replace('{code}', currentCamera.code || '')
        .replace('{area}', currentCamera.area || '')
        .replace('{section}', currentCamera.section || '')
        .replace('{building}', currentCamera.building || '')
        .replace('{floor}', currentCamera.floor || '')
        .replace('{placeType}', currentCamera.placeType || '')
        .replace('{relativePlace}', currentCamera.relativePlace || '')
        .replace('{specificPlace}', currentCamera.specificPlace || '')
        .replace('{detail}', currentCamera.detail || '');
      document.getElementById('prompt-text').value = prompt;
      // å¼¹çª—èšç„¦æ—¶éšè—é®ç½©
      hideMapMask();
    }

    function closeModal() {
      document.getElementById("ai-modal").classList.add("hidden");
      document.getElementById("camera-upload").value = "";
      document.getElementById("camera-preview").classList.add("hidden");
      document.getElementById("camera-placeholder").style.display = "block";
      document.getElementById("result-box").textContent = 'ç‚¹å‡»"å¼€å§‹åˆ†æ"æŒ‰é’®è·å–AIåˆ†æç»“æœ...';
      // å–æ¶ˆä¾§è¾¹æ èšç„¦æ¸…æ™°
      document.querySelector('.sidebar').classList.remove('focus-clear');
      if (viewCone) map.removeLayer(viewCone);
      if (areaBox) map.removeLayer(areaBox);
      viewCone = null;
      areaBox = null;
      currentCamera = null;
      // å…³é—­å¼¹çª—æ—¶æ¢å¤é®ç½©
      showMapMask();
    }

    function openAddCameraModal() {
      document.getElementById('add-camera-modal').classList.remove('hidden');
      hideMapMask();
    }

    function closeAddCameraModal() {
      document.getElementById('add-camera-modal').classList.add('hidden');
      document.getElementById('add-name').value = '';
      document.getElementById('add-code').value = '';
      document.getElementById('add-lng').value = '';
      document.getElementById('add-lat').value = '';
      showMapMask();
    }

    function addCameraByForm() {
      const name = document.getElementById('add-name').value.trim();
      const code = document.getElementById('add-code').value.trim();
      const lng = parseFloat(document.getElementById('add-lng').value);
      const lat = parseFloat(document.getElementById('add-lat').value);
      const area = document.getElementById('add-area').value.trim();
      const section = document.getElementById('add-section').value.trim();
      const building = document.getElementById('add-building').value.trim();
      const floor = document.getElementById('add-floor').value.trim();
      const placeType = document.getElementById('add-placeType').value.trim();
      const relativePlace = document.getElementById('add-relativePlace').value.trim();
      const specificPlace = document.getElementById('add-specificPlace').value.trim();
      const detail = document.getElementById('add-detail').value.trim();
      if (!name) {
        showNotification('è¯·è¾“å…¥æ‘„åƒå¤´åç§°', 'error');
        return;
      }
      if (isNaN(lng) || isNaN(lat)) {
        showNotification('è¯·è¾“å…¥æœ‰æ•ˆçš„ç»åº¦å’Œçº¬åº¦', 'error');
        return;
      }
      cameraList.push({ name, code, lng, lat, area, section, building, floor, placeType, relativePlace, specificPlace, detail, status: 'online' });
      updateCameraList();
      updateMapMarkers();
      closeAddCameraModal();
      showNotification('æ‘„åƒå¤´æ·»åŠ æˆåŠŸ', 'success');
    }

    // æ–‡ä»¶å¤„ç†
    function processExcelFile(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

          const cameras = [];
          for (let i = 1; i < jsonData.length; i++) {
            const row = jsonData[i];
            if (row.length >= 3) {
              let name = row[0];
              if (typeof name !== 'string') {
                name = String(name || `æ‘„åƒå¤´-${String(i).padStart(3, '0')}`);
              }
              name = name.trim();

              const lng = parseFloat(row[1]);
              const lat = parseFloat(row[2]);

              if (!isNaN(lng) && !isNaN(lat)) {
                cameras.push({
                  name: name || `æ‘„åƒå¤´-${String(i).padStart(3, '0')}`,
                  lng: lng,
                  lat: lat,
                  status: 'online'
                });
              }
            }
          }

          if (cameras.length > 0) {
            cameraList = cameras;
            updateCameraList();
            updateMapMarkers();
            showNotification(`æˆåŠŸå¯¼å…¥ ${cameras.length} ä¸ªæ‘„åƒå¤´`, 'success');
          } else {
            showNotification('Excelæ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æ‘„åƒå¤´æ•°æ®', 'error');
          }
        } catch (error) {
          showNotification('Excelæ–‡ä»¶å¤„ç†å¤±è´¥ï¼š' + error.message, 'error');
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function processCSVFile(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const csvText = e.target.result;
          const lines = csvText.split('\n');
          const cameras = [];
          // å‡è®¾è¡¨å¤´é¡ºåºä¸ºï¼šå›½æ ‡ç¼–ç ,å¹³å°é•œå¤´åç§°,åŒºåŸŸ,ç‰‡åŒº,å»ºç­‘ç‰©,æ¥¼å±‚,åœºæ‰€ç±»å‹,ç›¸å¯¹åœºæ‰€ä½ç½®ä¿¡æ¯,å…·ä½“åœºæ‰€ä½ç½®ä¿¡æ¯,ç»†èŠ‚å¤‡æ³¨,ç°åœºå®é™…é•œå¤´åç§°,æªçƒç±»å‹,ç»åº¦,çº¬åº¦
          for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            const columns = line.split(',').map(col => col.trim().replace(/^['"]|['"]$/g, ''));
            if (columns.length >= 14) {
              const [code, name, area, section, building, floor, placeType, relativePlace, specificPlace, detail, realName, type, lngStr, latStr] = columns;
              const lng = parseFloat(lngStr);
              const lat = parseFloat(latStr);
              if (!isNaN(lng) && !isNaN(lat)) {
                cameras.push({
                  code, name, area, section, building, floor, placeType, relativePlace, specificPlace, detail, realName, type, lng, lat, status: 'online'
                });
              }
            }
          }
          if (cameras.length > 0) {
            cameraList = cameras;
            updateCameraList();
            updateMapMarkers();
            showNotification(`æˆåŠŸå¯¼å…¥ ${cameras.length} ä¸ªæ‘„åƒå¤´`, 'success');
          } else {
            showNotification('CSVæ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æ‘„åƒå¤´æ•°æ®', 'error');
          }
        } catch (error) {
          showNotification('CSVæ–‡ä»¶å¤„ç†å¤±è´¥ï¼š' + error.message, 'error');
        }
      };
      reader.readAsText(file, 'UTF-8');
    }

    // é€šçŸ¥ç³»ç»Ÿ
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 16px 24px;
        background: ${type === 'success' ? 'rgba(34, 197, 94, 0.9)' : type === 'error' ? 'rgba(239, 68, 68, 0.9)' : 'rgba(59, 130, 246, 0.9)'};
        color: white;
        border-radius: 12px;
        font-weight: 600;
        font-size: 14px;
        z-index: 9999;
        backdrop-filter: blur(20px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        transform: translateX(400px);
        transition: transform 0.3s ease;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => notification.style.transform = 'translateX(0)', 10);
      setTimeout(() => {
        notification.style.transform = 'translateX(400px)';
        setTimeout(() => document.body.removeChild(notification), 300);
      }, 3000);
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      initMap();

      // æ·»åŠ ç¤ºä¾‹æ‘„åƒå¤´
      cameraList.push(
        { name: "ä¸»å…¥å£ç›‘æ§", lat: 22.699, lng: 114.213, status: 'online' },
        { name: "åœè½¦åœºç›‘æ§", lat: 22.700, lng: 114.214, status: 'online' },
        { name: "åé—¨ç›‘æ§", lat: 22.698, lng: 114.212, status: 'maintenance' }
      );
      updateCameraList();
      updateMapMarkers();

      // äº‹ä»¶ç›‘å¬
      document.getElementById('excel-upload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) processExcelFile(file);
      });

      document.getElementById('csv-upload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) processCSVFile(file);
      });

      // æ»‘å—äº‹ä»¶
      const angleSlider = document.getElementById("angle-slider");
      const radiusSlider = document.getElementById("radius-slider");
      const angleValue = document.getElementById("angle-value");
      const radiusValue = document.getElementById("radius-value");

      angleSlider.addEventListener('input', function() {
        angleValue.textContent = this.value + 'Â°';
        try {
          if (currentCamera) {
            const radius = parseInt(radiusSlider.value);
            const angle = parseInt(this.value);
            if (
              isNaN(currentCamera.lat) || isNaN(currentCamera.lng) ||
              isNaN(angle) || isNaN(radius)
            ) return;
            const conePoints = drawViewCone(currentCamera.lat, currentCamera.lng, 135, angle, radius);
            const bounds = getBounds30m(currentCamera.lat, currentCamera.lng);
            const totalBounds = getCombinedBounds(conePoints, bounds);
            updateMapScreenshot(totalBounds);
          }
        } catch (e) {
          console.error('è§’åº¦æ»‘å—å¼‚å¸¸:', e);
        }
      });

      radiusSlider.addEventListener('input', function() {
        radiusValue.textContent = this.value + 'm';
        try {
          if (currentCamera) {
            const angle = parseInt(angleSlider.value);
            const radius = parseInt(this.value);
            if (
              isNaN(currentCamera.lat) || isNaN(currentCamera.lng) ||
              isNaN(angle) || isNaN(radius)
            ) return;
            const conePoints = drawViewCone(currentCamera.lat, currentCamera.lng, 135, angle, radius);
            const bounds = getBounds30m(currentCamera.lat, currentCamera.lng);
            const totalBounds = getCombinedBounds(conePoints, bounds);
            updateMapScreenshot(totalBounds);
          }
        } catch (e) {
          console.error('è·ç¦»æ»‘å—å¼‚å¸¸:', e);
        }
      });

      // å›¾ç‰‡ä¸Šä¼ é¢„è§ˆ
      document.getElementById("camera-upload").onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById("camera-placeholder").style.display = "none";
          document.getElementById("camera-preview").src = e.target.result;
          document.getElementById("camera-preview").classList.remove("hidden");
        };
        reader.readAsDataURL(file);
      };

      document.getElementById("map-upload").onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById("map-preview").src = e.target.result;
          document.getElementById("map-preview").classList.remove("hidden");
        };
        reader.readAsDataURL(file);
      };

           // æˆªå›¾æŒ‰é’®
           document.getElementById("screenshot-btn").onclick = function() {
        if (!currentCamera) return;
        const angle = parseInt(angleSlider.value);
        const radius = parseInt(radiusSlider.value);
        const conePoints = drawViewCone(currentCamera.lat, currentCamera.lng, 135, angle, radius);
        const bounds = getBounds30m(currentCamera.lat, currentCamera.lng);
        const totalBounds = getCombinedBounds(conePoints, bounds);
        updateMapScreenshot(totalBounds);
      };

      // åˆ†ææŒ‰é’®
      document.getElementById("analyze-btn").onclick = function() {
        const file = document.getElementById("camera-upload").files[0];
        if (!file) {
          showNotification("è¯·ä¸Šä¼ æ‘„åƒå¤´ç”»é¢", 'error');
          return;
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const analyzeBtn = document.getElementById("analyze-btn");
        const originalText = analyzeBtn.textContent;
        analyzeBtn.textContent = "åˆ†æä¸­...";
        analyzeBtn.classList.add("loading");
        analyzeBtn.disabled = true;
        
        // åœ¨æŠ½å±‰ä¸­æ˜¾ç¤ºåˆ†æç»“æœ
        document.getElementById("drawer-result-box").textContent = "ğŸ§  AIæ­£åœ¨åˆ†æä¸­ï¼Œè¯·ç¨å€™...";
        document.getElementById("ai-drawer").classList.add("open");
        
        document.getElementById("map-canvas").toBlob(blob => {
          const formData = new FormData();
          formData.append("camera_image", file);
          formData.append("map_image", blob, "map.png");
          formData.append("prompt", document.getElementById("prompt-text").value);
          const model = document.getElementById("ai-model-select")?.value || "qwen";
          formData.append("model", model);
          
          fetch("/analyze_camera", {
            method: "POST",
            body: formData
          })
          .then(res => res.json())
          .then(data => {
            const result = data.result || data.choices?.[0]?.message?.content || "æ¨¡å‹æœªè¿”å›æœ‰æ•ˆç»“æœ";
            document.getElementById("result-box").innerHTML = marked.parse(result);
            document.getElementById("drawer-result-box").innerHTML = marked.parse(result);
          })
          .catch(err => {
            const errMsg = "åˆ†æå¤±è´¥: " + err.message;
            document.getElementById("result-box").textContent = errMsg;
            document.getElementById("drawer-result-box").textContent = errMsg;
            showNotification(errMsg, 'error');
          })
          .finally(() => {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            analyzeBtn.textContent = originalText;
            analyzeBtn.classList.remove("loading");
            analyzeBtn.disabled = false;
          });
        }, "image/png");
      };

      // ä¿å­˜æŒ‰é’®
      document.getElementById("save-btn").onclick = function() {
        if (!currentCamera) return;
        
        // æ›´æ–°æ‘„åƒå¤´ä¿¡æ¯
        currentCamera.name = document.getElementById('camera-name').value;
        currentCamera.code = document.getElementById('camera-code').value;
        
        // æ›´æ–°åˆ—è¡¨ä¸­çš„æ‘„åƒå¤´
        cameraList[currentCamera.index] = { ...currentCamera };
        delete cameraList[currentCamera.index].index;
        
        updateCameraList();
        updateMapMarkers();
        closeModal();
        showNotification('æ‘„åƒå¤´ä¿¡æ¯å·²ä¿å­˜', 'success');
      };

      // AIåˆ†ææŠ½å±‰æ§åˆ¶
      const drawer = document.getElementById("ai-drawer");
      const toggleBtn = document.getElementById("toggle-analysis");
      const closeBtn = document.getElementById("close-analysis");

      if (toggleBtn) {
        toggleBtn.addEventListener("click", () => {
          drawer.classList.toggle("open");
        });
      }

      if (closeBtn) {
        closeBtn.addEventListener("click", () => {
          drawer.classList.remove("open");
        });
      }

      // ç‚¹å‡»æŠ½å±‰å¤–éƒ¨å…³é—­
      document.addEventListener('click', function(e) {
        if (drawer.classList.contains('open') && 
            !drawer.contains(e.target) && 
            e.target !== toggleBtn) {
          drawer.classList.remove('open');
        }
      });

      // ESCé”®å…³é—­æŠ½å±‰å’Œæ¨¡æ€æ¡†
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          if (drawer.classList.contains('open')) {
            drawer.classList.remove('open');
          }
          if (!document.getElementById('ai-modal').classList.contains('hidden')) {
            closeModal();
          }
          if (!document.getElementById('add-camera-modal').classList.contains('hidden')) {
            closeAddCameraModal();
          }
        }
      });

      // æ‹–æ‹½åŠŸèƒ½
      if (typeof interact !== 'undefined') {
        interact('#modal-content').draggable({
          allowFrom: '.modal-header',
          listeners: {
            start: function(event) {
              event.target.style.transition = 'none';
            },
            move: function(event) {
              const target = event.target;
              const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
              const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
              target.style.transform = `translate(${x}px, ${y}px)`;
              target.setAttribute('data-x', x);
              target.setAttribute('data-y', y);
            },
            end: function(event) {
              event.target.style.transition = '';
            }
          }
        });
      }

      // ç§»åŠ¨ç«¯é€‚é…
      function handleMobileLayout() {
        const isMobile = window.innerWidth <= 768;
        const sidebar = document.querySelector('.sidebar');
        
        if (isMobile) {
          sidebar.classList.add('mobile-hidden');
          // æ·»åŠ ç§»åŠ¨ç«¯èœå•æŒ‰é’®
          if (!document.getElementById('mobile-menu-btn')) {
            const menuBtn = document.createElement('button');
            menuBtn.id = 'mobile-menu-btn';
            menuBtn.className = 'control-btn';
            menuBtn.style.cssText = `
              position: fixed;
              top: 20px;
              left: 20px;
              z-index: 31;
              padding: 12px;
            `;
            menuBtn.innerHTML = `
              <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
              </svg>
            `;
            menuBtn.onclick = () => sidebar.classList.toggle('open');
            document.body.appendChild(menuBtn);
          }
        } else {
          sidebar.classList.remove('mobile-hidden', 'open');
          const menuBtn = document.getElementById('mobile-menu-btn');
          if (menuBtn) menuBtn.remove();
        }
      }

      // åˆå§‹åŒ–ç§»åŠ¨ç«¯å¸ƒå±€
      handleMobileLayout();
      window.addEventListener('resize', handleMobileLayout);

      console.log('AIè§†è§‰ç›‘æ§ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');

      // é»˜è®¤æ˜¾ç¤ºé®ç½©
      showMapMask();
    });

    // å·¥å…·å‡½æ•°
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function throttle(func, limit) {
      let inThrottle;
      return function() {
        const args = arguments;
        const context = this;
        if (!inThrottle) {
          func.apply(context, args);
          inThrottle = true;
          setTimeout(() => inThrottle = false, limit);
        }
      }
    }

    // æ€§èƒ½ä¼˜åŒ–çš„æ»‘å—æ›´æ–°
    const debouncedUpdateScreenshot = debounce(function(bounds) {
      updateMapScreenshot(bounds);
    }, 300);

    // å¯¼å‡ºåŠŸèƒ½
    function exportCameraData() {
      const dataStr = JSON.stringify(cameraList, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      
      const exportFileDefaultName = `æ‘„åƒå¤´æ•°æ®_${new Date().toISOString().split('T')[0]}.json`;
      
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();
      
      showNotification('æ‘„åƒå¤´æ•°æ®å·²å¯¼å‡º', 'success');
    }

    // æ·»åŠ å¯¼å‡ºæŒ‰é’®åˆ°æ§åˆ¶é¢æ¿
    function addExportButton() {
      const controlPanel = document.querySelector('.control-panel');
      const exportBtn = document.createElement('button');
      exportBtn.className = 'control-btn';
      exportBtn.innerHTML = `
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        å¯¼å‡ºæ•°æ®
      `;
      exportBtn.onclick = exportCameraData;
      controlPanel.appendChild(exportBtn);
    }

    // é¡µé¢åŠ è½½å®Œæˆåæ·»åŠ å¯¼å‡ºæŒ‰é’®
    window.addEventListener('load', () => {
      addExportButton();
    });

    // å…¨å±€é”™è¯¯å¤„ç†
    window.addEventListener('error', function(e) {
      console.error('å…¨å±€é”™è¯¯:', e.error);
      showNotification('ç³»ç»Ÿå‘ç”Ÿé”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
    });

    // ç½‘ç»œçŠ¶æ€ç›‘å¬
    window.addEventListener('online', () => {
      showNotification('ç½‘ç»œè¿æ¥å·²æ¢å¤', 'success');
    });

    window.addEventListener('offline', () => {
      showNotification('ç½‘ç»œè¿æ¥å·²æ–­å¼€', 'error');
    });

    // ä¾§è¾¹æ èšç„¦æ—¶ä¹Ÿéšè—é®ç½©
    document.querySelector('.sidebar').addEventListener('mouseenter', hideMapMask);
    document.querySelector('.sidebar').addEventListener('mouseleave', showMapMask);
  </script>
</body>
</html>

